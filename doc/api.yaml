openapi: 3.0.3
info:
  title: WASAText
  description: |
    API for messaging app WASAText
  version: 0.0.1
security:
  - bearerAuth: [ ]
tags:
  - name: login
    description: login operations
  - name: user
    description: user operations
  - name: chats
    description: chats operations
  - name: messages
    description: messages operations
  - name: comments
    description: comment operations
paths:
  /session:
    post:
      tags: [ "login" ]
      summary: Logs in the user
      description: |
        If the user does not exist, it will be created,
        and an identifier is returned.
        If the user exists, the user identifier is returned
      operationId: doLogin
      requestBody:
        description: User details
        content:
          application/json:
            schema:
              description: username for login
              type: object
              properties:
                name:
                  description: Username
                  type: string
                  example: Maria
                  pattern: "^[a-zA-Z0-9_-]+$"
                  minLength: 3
                  maxLength: 16
        required: true
      responses:
        '201':
          description: User log-in action successful
          content:
            application/json:
              schema:
                type: object
                description: Unique user bearer token
                properties:
                  identifier:
                    description: Bearer token
                    type: string
                    example: "12et43-35432-g53kg5"
  /users:
    get:
      tags:
        - user
      summary: Get the registered users
      description: 'Returns a json array of the users in the app'
      operationId: getUsers
      responses:
        "200":
          description: Username updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    put:
      tags:
        - user
      summary: Updates the username
      description: 'Updates the username with the one given in the request.
                    Requires a valid Bearer token in the Authorization header.'
      operationId: setMyUserName
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UsernameRequest"
        required: true
      responses:
        "200":
          description: Username updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /users/image:
    get:
      tags:
        - user
      summary: Get user image url
      description: Retrieve the url where the user profile picture is stored in the server
      operationId: getMyPhoto
      responses:
        "200":
          description: Image url fetched successfully.
          content:
            application/json:
              schema:
                type: object
                description: url or oath where the image is stored in the server
                properties:
                  imageUrl:
                    description: image url
                    type: string
                    format: uri
                    example: https://cdn.example.com/users/12345/profile.jpg
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    put:
      tags:
        - user
      summary: Sets user profile photo
      description: >
        Updates the profile picture for the authenticated user.
        Requires a valid Bearer token in the Authorization header.
      operationId: setMyPhoto
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              description: image loaded by the user to update the profile picture
              properties:
                file:
                  type: string
                  format: binary
                  description: The image file to upload.
      responses:
        "200":
          description: Profile image updated successfully.
          content:
            application/json:
              schema:
                type: object
                description: successful response when updating the profile picture
                properties:
                  success:
                    description: successful operation
                    type: boolean
                    example: true
                  message:
                    description: response message
                    type: string
                    example: Profile image updated successfully.
                  imageUrl:
                    description: image url
                    type: string
                    format: uri
                    example: https://cdn.example.com/users/12345/profile.jpg
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /chats:
    get:
      tags:
        - chats
      operationId: getMyConversations
      summary: Get user chats
      description: "Get all the user's conversations"
      responses:
        "200":
          description: Chats found
          content:
            application/json:
              schema:
                description: chats
                type: array
                items:
                  $ref: "#/components/schemas/Chat"
                minItems: 1
                maxItems: 999
        "204":
          description: "No Chats"
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    post:
      tags:
        - chats
      summary: Create new Chat
      description: |
        Create a new conversation with an optional initial message.
        Supports both text messages (JSON) and media messages (multipart/form-data).
        If it's the first message between users, a new conversation will be created.
      operationId: createChat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/FirstMessageRequest"
            examples:
              textMessage:
                summary: Text message example
                value:
                  text: "Hello, team!"
                  type: "text"
                  chatName: "Project X"
                  receivers: [ "alice", "bob", "mark" ]
                  isForward: false
              noInitialMessage:
                summary: Create chat without initial message
                value:
                  chatName: "Project X"
                  receivers: [ "alice", "bob" ]
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/FirstMessageFormData"
            examples:
              imageMessage:
                summary: Image message example
                value:
                  type: "image"
                  text: "Check out this photo!"
                  chatName: "Project X"
                  receivers: '["alice", "bob", "mark"]'
                  isForward: "false"
                  image: "(binary image data)"
      responses:
        '201':
          description: New chat created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Chat'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /chats/{chatId}:
    parameters:
      - $ref: "#/components/parameters/ChatID"
      - name: chatName
        in: query
        description: New group name
        schema:
          type: string
          description: Group name
          example: "Study group"
          pattern: "^[a-zA-Z0-9_ -]+$"
          minLength: 3
          maxLength: 24
    get:
      tags:
        - chats
      summary: Get messages in a chat
      description: Returns an array of messages sent in a chat
      operationId: getConversation
      responses:
        "200":
          description: Messages found
          content:
            application/json:
              schema:
                description: chat messages
                type: array
                items:
                  $ref: "#/components/schemas/Message"
                minItems: 1
                maxItems: 99999
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    put:
      tags:
        - chats
      summary: Updates the group name
      description: "Updates the group name with the one given in the request"
      operationId: setGroupName
      requestBody:
        content:
          application/json:
            schema:
              type: object
              description: new name of the group chat set by the user
              properties:
                chatName:
                  type: string
                  description: Name of the chat to create if new.
                  example: "Project X"

      responses:
        "200":
          description: Chat name updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Chat"
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags:
        - chats
      summary: Delete chat
      description: "Delete a chat"
      operationId: deleteChat
      responses:
        "204":
          description: Chat successfully deleted
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /chats/{chatId}/members:
    parameters:
      - $ref: "#/components/parameters/ChatID"
    get:
      tags:
        - chats
      operationId: getGroupMembers
      summary: get the list of members of the group chat
      description: "Return the list of users members of the group chat"
      responses:
        "200":
          description: Chat members fetched successfully
          content:
            application/json:
              schema:
                description: chat members
                type: array
                items:
                  $ref: "#/components/schemas/User"
                minItems: 1
                maxItems: 9999
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - chats
      operationId: addToGroup
      summary: Add user to group
      description: "Add an user to a a group. If user is already present, nothing will change"
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UsernameRequest'
      responses:
        "201":
          description: User added to chat
          content:
            application/json:
              schema:
                description: chat members
                type: array
                items:
                  $ref: "#/components/schemas/User"
                minItems: 1
                maxItems: 9999
        "400":
          $ref: '#/components/responses/BadRequestError'
        "409":
          $ref: '#/components/responses/ConflictError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags:
        - chats
      summary: Leave group
      description: "Remove an user from a group. Users can only remove themselves."
      operationId: leaveGroup
      responses:
        "200":
          description: Group has been left
          content:
            application/json:
              schema:
                description: chat members
                type: array
                items:
                  $ref: "#/components/schemas/User"
                minItems: 1
                maxItems: 9999
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /chats/{chatId}/image:
    parameters:
      - $ref: "#/components/parameters/ChatID"
    put:
      tags:
        - chats
      summary: Sets group profile photo
      description: "Updates the group profile picture with the one given in the request"
      operationId: setGroupPhoto
      requestBody:
        content:
          multipart/form-data:
            schema:
              description: group image
              type: string
              format: binary
              minLength: 1
              maxLength: 99999
        required: true
      responses:
        "200":
          description: Group image updated successfully.
          content:
            application/json:
              schema:
                type: object
                description: successful response when updating group chat image
                properties:
                  success:
                    description: successful operation
                    type: boolean
                    example: true
                  message:
                    description: response message
                    type: string
                    example: Group image updated successfully.
                  imageUrl:
                    description: image address
                    type: string
                    format: uri
                    example: https://cdn.example.com/users/12345/profile.jpg
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /uploads/{folder}/{filename}:
    get:
      summary: Get an uploaded image file
      description: Serves a static image file from the uploads directory.
        The file can be located in the `users`, `chats`, or `messages` folder.
        The request requires an Authorization header.
      tags:
        - media
      operationId: getImage
      parameters:
        - name: folder
          in: path
          required: true
          description: The folder where the image is stored (users, chats, messages)
          schema:
            type: string
            description: The folder where the image is stored (users, chats, messages)
            enum: [ user, chats, messages ]
        - name: filename
          in: path
          required: true
          description: The filename of the image to fetch (e.g. abc123.jpg)
          schema:
            description: The filename of the image to fetch (e.g. abc123.jpg)
            type: string
            example: "image.png"
      responses:
        '200':
          description: Image file fetched successfully
          content:
            image/jpeg:
              schema:
                description: The requested image file.
                type: string
                format: binary
            image/png:
              schema:
                description: The requested image file.
                type: string
                format: binary
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /chats/{chatId}/messages:
    parameters:
      - $ref: "#/components/parameters/ChatID"
    post:
      tags:
        - messages
      summary: Send a message
      description: |
        Send a new message in a conversation. If it's the first one,
        a new conversation will be created
      operationId: sendMessage
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MessageRequest"
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/MessageFormData"
        required: true
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /chats/{chatId}/messages/{messageId}:
    parameters:
      - $ref: "#/components/parameters/ChatID"
      - $ref: "#/components/parameters/MessageID"
    post:
      tags:
        - messages
      summary: Forward a message
      description: "Get a message to forward it"
      operationId: forwardMessage
      responses:
        "200":
          description: Message found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        "404":
          $ref: "#/components/responses/NotFoundError"
    delete:
      tags:
        - messages
      summary: Delete message
      description: "Delete a message"
      operationId: deleteMessage
      responses:
        "200":
          description: Message deleted successfully
          content:
            application/json:
              schema:
                type: object
                description: Response JSON for deleting messages lets the user know if the chat gets deleted as well
                properties:
                  chatDeleted:
                    type: boolean
                    description: flag to communicate if the chat is being deleted by cascade after the message deletion
                    example: false
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "404":
          $ref: '#/components/responses/NotFoundError'
        "500":
          $ref: '#/components/responses/InternalServerError'

  /messages/{messageId}/comments:
    parameters:
      - $ref: "#/components/parameters/ChatID"
      - $ref: "#/components/parameters/MessageID"
    get:
      tags:
        - comments
      operationId: getComments
      summary: Get message comments
      description: "Get all the message's comments"
      responses:
        "200":
          description: Comments found
          content:
            application/json:
              schema:
                description: message comments
                type: array
                items:
                  $ref: "#/components/schemas/Comment"
                minItems: 1
                maxItems: 9999
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    put:
      tags:
        - comments
      operationId: commentMessage
      summary: Comment a message
      description: "Add a comment to a message. If user's comment is already present, nothing will change"
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Comment'
      responses:
        "200":
          description: Comment added
          content:
            application/json:
              schema:
                description: message comments
                type: array
                items:
                  $ref: "#/components/schemas/Comment"
                minItems: 1
                maxItems: 9999
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags:
        - comments
      summary: Delete comment
      operationId: uncommentMessage
      description: "Remove user comment from a message. If no comment is present, nothing will change"
      responses:
        "200":
          description: Comment deleted
          content:
            application/json:
              schema:
                description: message comments
                type: array
                items:
                  $ref: "#/components/schemas/Comment"
                minItems: 1
                maxItems: 9999
        "400":
          $ref: '#/components/responses/BadRequestError'
        "401":
          $ref: '#/components/responses/UnauthorizedError'
        "500":
          $ref: '#/components/responses/InternalServerError'

components:
  schemas:
    User:
      title: User
      description: Unique user
      type: object
      properties:
        id:
          description: Unique identifier for the user
          type: integer
          example: 223
          readOnly: True
        username:
          description: username
          type: string
          example: 'mario'
          pattern: "^[a-zA-Z0-9_-]+$"
          minLength: 3
          maxLength: 16

    Chat:
      title: Chat
      description: Generic chat
      type: object
      properties:
        id:
          description: Unique identifier for the chat
          type: integer
          example: 223
          readOnly: True
        isGroup:
          description: identifies chat as a group or private chat
          type: boolean
          example: true
        chatName:
          description: Chat title, user name or group name
          type: string
          example: "Study group"
          pattern: "^[a-zA-Z0-9_ -]+$"
          minLength: 3
          maxLength: 24
        lastMsgText:
          description: text of the last message in the chat
          type: string
          example: "The meeting is canceled"
          pattern: "^[a-zA-Z0-9_ -]+$"
          minLength: 1
          maxLength: 99
        lastMsgTime:
          description: Date and time when the message is sent
          type: string
          format: date-time
          pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
          example: "2024-10-11T12:14:23Z"
          readOnly: true
          minLength: 20
          maxLength: 20
        lastMsgType:
          description: type of the message, either text or image
          type: string
          enum: ["text", "image"]
          example: "text"
        unread:
          description: unread messages count for the chat
          type: integer
          example: 3

    Message:
      title: Message
      description: Single message
      type: object
      properties:
        id:
          description: Unique identifier for the message
          type: integer
          example: 223
          readOnly: True
        type:
          description: type of the message, either text or image
          type: string
          enum: [ "text", "image" ]
          example: "text"
        text:
          description: message text
          type: string
          example: "hello world"
          pattern: "^[a-zA-Z0-9_ -]+$"
          minLength: 1
          maxLength: 250
        chatId:
          description: Identifier for the chat
          type: integer
          example: 223
        senderId:
          description: Identifier for the sender
          type: integer
          example: 223
        isForward:
          type: boolean
          description: Whether this message is forwarded from another chat.
          example: false
        replyTo:
          description: Identifier for the message this one is replying to
          type: integer
          example: 223
        createdAt:
          description: Date and time when the message is sent
          type: string
          format: date-time
          pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
          example: "2024-10-11T12:14:23Z"
          readOnly: true
          minLength: 20
          maxLength: 20


    Comment:
      title: Comment
      description: Single comment
      type: object
      properties:
        userId:
          description: Unique identifier for the comment's user
          type: integer
          example: 223
          readOnly: True
        timestamp:
          description: Date and time when the comment is put
          type: string
          format: date-time
          pattern: "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"
          example: "2024-10-11T12:14:23Z"
          readOnly: true
          minLength: 20
          maxLength: 20

    LoginRequest:
      title: Login Request
      description: Request consists in a string
      type: object
      properties:
        username:
          description: username
          type: string
          example: 'mario'
          pattern: "^[a-zA-Z0-9_-]+$"
          minLength: 3
          maxLength: 16

    UsernameRequest:
      title: Username Request
      description: Request consists in a string to change the username
      type: object
      properties:
        username:
          description: username
          type: string
          example: 'mario'
          pattern: "^[a-zA-Z0-9_-]+$"
          minLength: 3
          maxLength: 16

    MessageRequest:
      type: object
      properties:
        text:
          type: string
          description: The text content of the message (optional if no initial message)
          example: "Hello team!"
        type:
          type: string
          description: The type of message
          enum: [ "text", "image", "gif" ]
          example: "text"
        isForward:
          type: boolean
          description: Whether this message is forwarded from another chat
          default: false
          example: false
        replyTo:
          type: integer
          description: message id of the message of which this one is replying
          default: 0
          example: 223

    MessageFormData:
      type: object
      properties:
        type:
          type: string
          description: The type of message (required for media uploads)
          enum: [ "image", "gif" ]
          example: "image"
        text:
          type: string
          description: Optional caption/text content for the media
          example: "Check out this photo!"
        isForward:
          type: string
          description: Whether this message is forwarded (string representation of boolean)
          enum: [ "true", "false" ]
          default: "false"
          example: "false"
        replyTo:
          type: integer
          description: message id of the message of which this one is replying
          default: 0
          example: 223
        image:
          type: string
          format: binary
          description: The image or GIF file to upload (max 10MB)
      required:
        - type
        - image
      additionalProperties: false

    FirstMessageRequest:
      type: object
      properties:
        text:
          type: string
          description: The text content of the message (optional if no initial message)
          example: "Hello World!"
        type:
          type: string
          description: The type of message
          enum: [ "text", "image", "gif" ]
          example: "text"
        chatName:
          type: string
          description: Name of the chat to create (required for group chats with multiple receivers)
          example: "Project X"
        receivers:
          type: array
          description: List of usernames to receive the message
          items:
            type: string
          minItems: 1
          maxItems: 99
          example: [ "alice", "bob", "mark" ]
        isForward:
          type: boolean
          description: Whether this message is forwarded from another chat
          default: false
          example: false
      required:
        - receivers
      additionalProperties: false

    FirstMessageFormData:
      type: object
      properties:
        type:
          type: string
          description: The type of message (required for media uploads)
          enum: [ "image", "gif" ]
          example: "image"
        text:
          type: string
          description: Optional caption/text content for the media
          example: "Check out this photo!"
        chatName:
          type: string
          description: Name of the chat to create (required for group chats with multiple receivers)
          example: "Project X"
        receivers:
          type: string
          description: JSON string array of usernames to receive the message
          example: '["alice", "bob", "mark"]'
        isForward:
          type: string
          description: Whether this message is forwarded (string representation of boolean)
          enum: [ "true", "false" ]
          default: "false"
          example: "false"
        image:
          type: string
          format: binary
          description: The image or GIF file to upload (max 10MB)
      required:
        - type
        - receivers
        - image
      additionalProperties: false

    Error:
      type: object
      properties:
        error:
          type: string
          example: "Invalid request"
        message:
          type: string
          example: "The request could not be processed"
        code:
          type: integer
          example: 400

  parameters:
    ChatID:
      schema:
        description: identifier for the chat
        type: number
        format: integer
        example: 134
      name: chatId
      in: path
      required: true
      description: Chat identifier

    MessageID:
      schema:
        description: identifier for the message
        type: number
        format: integer
        example: 134
      name: messageId
      in: path
      required: true
      description: Message identifier

    CommentID:
      schema:
        description: identifier for the comment
        type: number
        format: integer
        example: 134
      name: commentId
      in: path
      required: true
      description: Comment identifier

  responses:
    UnauthorizedError:
      description: Invalid or missing bearer token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    ConflictError:
      description: Conflict error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    BadRequestError:
      description: Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalServerError:
      description: Internal Server Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
