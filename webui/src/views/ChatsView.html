<div class="container-fluid">
	<div class="row">
		<!-- Sidebar with conversation list -->
		<div class="col-md-4 col-lg-3 chat-sidebar">
			<div class="sidebar-sticky pt-3">
				<!-- Updated Header with user image and action icons -->
				<div class="d-flex justify-content-between align-items-center px-3 mb-3">
					<!-- User Profile Section -->
					<div class="d-flex align-items-center">
						<div class="user-profile-avatar me-3" @click="showProfileModal = true" style="cursor: pointer;" title="Edit Profile">
							<div class="avatar-circle" v-if="!currentUserImageUrl" style="width: 40px; height: 40px;">
								<span class="avatar-text" style="font-size: 16px;">{{ getUserInitials(currentUsername || 'User') }}</span>
							</div>
							<img
								v-else
								:src="currentUserImageUrl"
								:alt="currentUsername || 'User'"
								class="avatar-image"
								style="width: 40px; height: 40px;"
								@error="handleUserImageError"
							>
						</div>
						<div>
							<h5 class="mb-0">Chats</h5>
							<small class="text-muted">{{ currentUsername || 'User' }}</small>
						</div>
					</div>

					<!-- Action Icons -->
					<div class="d-flex chat-gap-2">
						<button
							class="btn btn-sm btn-outline-secondary p-1 chat-btn-icon"
							@click="openNewChatModal"
							title="New Chat"
						>
							<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
								<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
							</svg>
						</button>
						<button
							class="btn btn-sm btn-outline-danger p-1 chat-btn-icon"
							@click="logout"
							title="Logout"
						>
							<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
								<path fill-rule="evenodd"
									  d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z"/>
								<path fill-rule="evenodd"
									  d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z"/>
							</svg>
						</button>
					</div>
				</div>

				<LoadingSpinner v-if="loading" class="d-flex justify-content-center my-5"/>
				<ErrorMsg v-if="error" :message="error" class="mx-3"/>

				<!-- Modern chat list -->
				<div v-if="!loading && !error" class="chat-list">
					<div
						v-for="chat in chats"
						:key="chat.id"
						class="chat-item"
						:class="{ active: selectedChatId === chat.id }"
						@click="selectChat(chat.id)"
					>
						<div class="chat-avatar">
							<div class="avatar-circle" v-if="!chat.image">
								<span class="avatar-text">{{ getChatInitials(chat) }}</span>
							</div>
							<img
								v-else
								:src="chatImageUrls[chat.id]"
								:alt="getChatName(chat)"
								class="avatar-image"
								:data-chat-id="chat.id"
								@error="handleImageError"
							>
						</div>
						<div class="chat-info">
							<div class="chat-header">
								<h6 class="chat-name">{{ getChatName(chat) }}</h6>
								<span class="chat-time">{{ formatMessageTime(chat.lastMsgTime) }}</span>
							</div>
							<div class="chat-preview">
								<p class="last-message">{{ getLastMessagePreview(chat) }}</p>
								<div class="chat-preview-meta d-flex align-items-center justify-content-between">
									<div class="message-type-indicator">
										<span v-if="chat.lastMsgType === 'text'" class="message-type-icon">ðŸ’¬</span>
										<span v-else-if="chat.lastMsgType === 'image'" class="message-type-icon">ðŸ“·</span>
										<span v-else class="message-type-icon">ðŸ“Ž</span>
									</div>
									<div v-if="chat.unread > 0" class="unread-badge">
										{{ chat.unread > 99 ? '99+' : chat.unread }}
									</div>
								</div>
							</div>
						</div>
					</div>

					<div v-if="chats.length === 0" class="chat-empty-state">
						<div class="chat-empty-icon">
							<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
								 stroke-width="1.5">
								<path
									d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
							</svg>
						</div>
						<h6 class="text-muted">No conversations yet</h6>
						<p class="text-muted small">Start chatting by creating a new conversation</p>
					</div>
				</div>
			</div>
		</div>

		<!-- Main conversation area -->
		<main class="col-md-8 col-lg-9 ms-sm-auto px-md-4">
			<div v-if="!selectedChatId" class="d-flex justify-content-center align-items-center h-100">
				<div class="text-center text-muted">
					<div class="mb-3">
						<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							 stroke-width="1.5">
							<path
								d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
						</svg>
					</div>
					<h5>Select a conversation to start chatting</h5>
					<p class="mb-4">Or create a new chat to get started</p>
					<button class="btn btn-primary" @click="openNewChatModal">New Chat</button>
				</div>
			</div>

			<div v-else class="chat-container h-100 d-flex flex-column">
				<!-- Chat header -->
				<div class="chat-header-bar p-3 border-bottom bg-light">
					<div class="d-flex justify-content-between align-items-center">
						<h5 class="mb-0">{{ selectedChat ? getChatName(selectedChat) : '' }}</h5>
						<div v-if="selectedChat && selectedChat.isGroup" class="dropdown">
							<button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
								<span class="feather">â‹®</span>
							</button>
							<ul class="dropdown-menu dropdown-menu-end">
								<li>
									<button class="dropdown-item" @click="openSetGroupNameModal">Rename Group</button>
								</li>
								<li>
									<button class="dropdown-item" @click="openAddToGroupModal">Add Member</button>
								</li>
								<li>
									<button class="dropdown-item" @click="openSetGroupPhotoModal">Set Group Photo</button>
								</li>
								<li>
									<hr class="dropdown-divider">
								</li>
								<li>
									<button class="dropdown-item text-danger" @click="leaveGroup">Leave Group</button>
								</li>
							</ul>
						</div>
					</div>
				</div>

				<!-- Messages list -->
				<div class="messages-container flex-grow-1 overflow-auto p-3" ref="messagesContainer">
					<LoadingSpinner v-if="loadingMessages" class="d-flex justify-content-center my-5"/>
					<ErrorMsg v-if="messagesError" :message="messagesError"/>

					<div v-if="!loadingMessages && !messagesError" class="messages-list">
						<!-- Enhanced message display with image support -->
						<div
							v-for="message in messages"
							:key="message.id"
							class="message-wrapper mb-3"
							:class="{ 'message-sent': isCurrentUserMessage(message) }"
						>
							<div class="message-content" style="position: relative;">
								<!-- Show sender name for group chats and incoming messages -->
								<div
									v-if="selectedChat?.isGroup && !isCurrentUserMessage(message)"
									class="message-sender"
								>
									{{ message.username }}
								</div>

								<div class="message-bubble" :class="{ 'has-likes': message.likes && message.likes.length > 0 }" style="position: relative;">
									<!-- Image Message -->
									<div v-if="message.type === 'image' || message.type === 'gif'">
										<!-- Loading state -->
										<div v-if="message.imageLoading" class="image-loading">
											<div class="spinner-border spinner-border-sm" role="status">
												<span class="visually-hidden">Loading image...</span>
											</div>
											<span class="ms-2">Loading image...</span>
										</div>

										<!-- Error state -->
										<div v-else-if="message.imageError" class="image-error">
											<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
												<path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
											</svg>
											Failed to load image
										</div>

										<!-- Actual image -->
										<img
											v-else-if="messageImageUrls[message.id]"
											:src="messageImageUrls[message.id]"
											:alt="message.mediaUrl || 'Image'"
											class="message-image"
											@click="openImageViewer(messageImageUrls[message.id], message.mediaUrl)"
											@error="handleMessageImageError(message)"
										>

										<!-- Fallback if no image URL -->
										<div v-else class="image-error">
											<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
												<path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
												<path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
											</svg>
											Image unavailable
										</div>

										<!-- Caption/text if present -->
										<div v-if="message.text && message.text.trim()" class="message-text image-caption">
											{{ message.text }}
										</div>
									</div>

									<!-- Text Message (original) -->
									<div v-else class="message-text">{{ message.text }}</div>

									<div class="message-meta">
										<span class="message-time">{{ formatMessageTime(message.createdAt) }}</span>
										<span v-if="isCurrentUserMessage(message)" class="message-status">
											<!-- Double checkmark for read messages -->
											<svg
												v-if="isMessageRead(message)"
												class="message-status-read"
												viewBox="0 0 18 12"
												fill="none"
												xmlns="http://www.w3.org/2000/svg"
											>
												<path
													d="M1 6L4 9L10 3"
													stroke="currentColor"
													stroke-width="1.5"
													stroke-linecap="round"
													stroke-linejoin="round"
												/>
												<path
													d="M7 6L10 9L16 3"
													stroke="currentColor"
													stroke-width="1.5"
													stroke-linecap="round"
													stroke-linejoin="round"
												/>
											</svg>

											<!-- Single checkmark for sent but not read messages -->
											<svg
												v-else
												class="message-status-sent"
												viewBox="0 0 12 12"
												fill="none"
												xmlns="http://www.w3.org/2000/svg"
											>
												<path
													d="M1 6L4 9L10 3"
													stroke="currentColor"
													stroke-width="1.5"
													stroke-linecap="round"
													stroke-linejoin="round"
												/>
											</svg>
										</span>
									</div>

									<!-- Like Count Display -->
									<div
										v-if="message.likes && message.likes.length > 0"
										class="message-likes"
										@click="toggleLikesDropdown(message.id)"
										@click.stop
									>
										<svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
											<path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.011L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
										</svg>
										{{ message.likes.length }}

										<!-- Likes Dropdown -->
										<div
											v-if="showLikesDropdown === message.id"
											class="likes-dropdown"
											@click.stop
										>
											<div class="likes-list">
												<div
													v-for="username in message.likes"
													:key="username"
													class="like-user"
												>
													{{ username }}
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- Hover Like and Delete Buttons -->
								<div class="message-hover-actions">
									<!-- Like Button (existing) -->
									<button
										class="like-btn"
										:class="{ liked: isMessageLikedByUser(message) }"
										@click="toggleMessageLike(message)"
									>
										<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
											<path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.011L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
										</svg>
									</button>

									<!-- Delete Button (new) -->
									<button
										class="delete-btn"
										:class="{ loading: deletingMessage === message.id }"
										@click="toggleDeleteDropdown(message.id)"
										@click.stop
										:disabled="deletingMessage === message.id"
										v-if="isCurrentUserMessage(message)"
									>
										<div v-if="deletingMessage === message.id" class="spinner-border spinner-border-sm" role="status">
											<span class="visually-hidden">Deleting...</span>
										</div>
										<svg v-else width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
											<path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
										</svg>

										<!-- Delete Dropdown -->
										<div
											v-if="showDeleteDropdown === message.id"
											class="delete-dropdown"
											@click.stop
										>
											<div
												class="delete-option"
												@click="confirmDeleteMessage(message)"
											>
												<svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
													<path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
												</svg>
												Delete Message
											</div>
										</div>
									</button>
								</div>
							</div>
						</div>

						<!-- Show loading indicator for pending message -->
						<div v-if="sendingMessage" class="message-wrapper mb-3 message-sent">
							<div class="message-content">
								<div class="message-bubble message-pending">
									<div class="message-text">{{ pendingMessage }}</div>
									<div class="message-meta">
										<span class="message-time">{{ formatMessageTime(new Date()) }}</span>
										<span class="message-status">
											<div class="spinner-border spinner-border-sm message-status-pending" role="status">
												<span class="visually-hidden">Sending...</span>
											</div>
										</span>
									</div>
								</div>
							</div>
						</div>
						<div v-if="messages.length === 0" class="text-center p-4 text-muted">
							<div class="mb-3">
								<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
									 stroke-width="1.5">
									<path
										d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
								</svg>
							</div>
							<h6>No messages yet</h6>
							<p class="text-muted small">Start the conversation by sending a message</p>
						</div>
					</div>

					<!-- New Message Indicator - Fixed positioning and visibility -->
					<div
						v-if="hasNewMessages && newMessageCount > 0"
						class="new-message-indicator"
						@click="scrollToNewMessages"
					>
						<div class="new-message-content">
							<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
								<path d="M8 4a.5.5 0 0 1 .5.5v5.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708L7.5 10.293V4.5A.5.5 0 0 1 8 4z"/>
							</svg>
							<span>{{ newMessageCount }} new message{{ newMessageCount > 1 ? 's' : '' }}</span>
						</div>
					</div>
				</div>

				<!-- Message input -->
				<div class="message-input-container p-3 border-top bg-light">
					<form @submit.prevent="sendMessage">
						<!-- Show selected image preview if any -->
						<div v-if="selectedMessageImage" class="selected-image-preview mb-3">
							<div class="image-preview-container">
								<img
									:src="messageImagePreviewUrl"
									:alt="selectedMessageImage.name"
									class="preview-message-image"
								>
								<button
									type="button"
									class="btn btn-sm btn-danger remove-image-btn"
									@click="clearMessageImageSelection"
									title="Remove image"
								>
									<svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
										<path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
									</svg>
								</button>
							</div>
							<div class="image-info">
								<small class="text-muted">{{ selectedMessageImage.name }} ({{ formatFileSize(selectedMessageImage.size) }})</small>
							</div>
						</div>

						<div class="input-group">
							<!-- Add Media Button -->
							<button
								type="button"
								class="btn btn-outline-secondary add-media-btn"
								@click="openImageModal"
								title="Add image or GIF"
								:disabled="sendingMessage"
							>
								<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
								</svg>
							</button>

							<input
								type="text"
								class="form-control message-input"
								:placeholder="selectedMessageImage ? 'Add a caption...' : 'Type a message...'"
								v-model="newMessage"
								:disabled="sendingMessage"
								@keypress.enter="sendMessage"
							>
							<button
								class="btn btn-primary send-btn"
								type="submit"
								:disabled="sendingMessage || (!newMessage.trim() && !selectedMessageImage)"
							>
								<svg v-if="!sendingMessage" width="16" height="16" fill="currentColor"
									 viewBox="0 0 16 16">
									<path
										d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
								</svg>
								<LoadingSpinner v-else style="width: 16px; height: 16px;"/>
							</button>
						</div>
					</form>
				</div>
			</div>
		</main>
	</div>

	<!-- New Chat Modal -->
	<div class="vue-modal" v-if="showNewChatModal" @click.self="closeNewChatModal">
		<div class="vue-modal-dialog">
			<div class="vue-modal-content">
				<div class="vue-modal-header">
					<h5 class="vue-modal-title">New Conversation</h5>
					<button type="button" class="vue-modal-close" @click="closeNewChatModal">Ã—</button>
				</div>
				<div class="vue-modal-body">
					<!-- User Selection Section -->
					<div class="mb-4">
						<label class="form-label">Select Recipients</label>
						<div class="user-search-container mb-3">
							<div class="input-group">
								<input
									type="text"
									class="form-control"
									placeholder="Search users..."
									v-model="userSearchQuery"
									@input="filterUsers"
								>
								<button class="btn btn-outline-secondary" type="button" @click="getUsers">
									<svg v-if="!loadingUsers" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
										<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
									</svg>
									<div v-else class="spinner-border spinner-border-sm" role="status">
										<span class="visually-hidden">Loading...</span>
									</div>
								</button>
							</div>
						</div>

						<!-- Loading state for users -->
						<div v-if="loadingUsers" class="text-center py-3">
							<div class="spinner-border" role="status">
								<span class="visually-hidden">Loading users...</span>
							</div>
						</div>

						<!-- Users list -->
						<div v-else-if="filteredUsers.length > 0" class="user-list border rounded p-2" style="max-height: 200px; overflow-y: auto;">
							<div
								v-for="user in filteredUsers"
								:key="user.id"
								class="user-item d-flex align-items-center p-2 rounded hover-bg-light"
								style="cursor: pointer;"
								@click="toggleUserSelection(user)"
							>
								<input
									type="checkbox"
									class="form-check-input me-3"
									:checked="selectedUsers.some(u => u.id === user.id)"
									@click.stop="toggleUserSelection(user)"
								>
								<div class="user-avatar me-3">
									<div class="avatar-circle" style="width: 32px; height: 32px; font-size: 12px;">
										<span class="avatar-text">{{ getUserInitials(user.username) }}</span>
									</div>
								</div>
								<div class="user-info">
									<div class="fw-medium">{{ user.username }}</div>
								</div>
							</div>
						</div>

						<!-- No users found -->
						<div v-else-if="users.length === 0 && !loadingUsers" class="text-center py-3 text-muted">
							<p>No users found. Click search to load users.</p>
						</div>

						<!-- No filtered results -->
						<div v-else-if="filteredUsers.length === 0 && userSearchQuery && !loadingUsers" class="text-center py-3 text-muted">
							<p>No users found matching "{{ userSearchQuery }}"</p>
						</div>
					</div>

					<!-- Selected Users Display -->
					<div v-if="selectedUsers.length > 0" class="mb-3">
						<label class="form-label">Selected Recipients ({{ selectedUsers.length }})</label>
						<div class="selected-users d-flex flex-wrap gap-2">
					<span
						v-for="user in selectedUsers"
						:key="user.id"
						class="badge bg-primary d-flex align-items-center gap-1"
					>
						{{ user.username }}
						<button
							type="button"
							class="btn-close btn-close-white"
							style="font-size: 0.7em;"
							@click="removeUserSelection(user)"
						></button>
					</span>
						</div>
					</div>

					<!-- Group Name Input (show if multiple users selected) -->
					<div v-if="selectedUsers.length > 1" class="mb-3">
						<label class="form-label">Group Name <span class="text-danger">*</span></label>
						<input
							type="text"
							class="form-control"
							v-model="newChatName"
							placeholder="Enter group name"
							required
						>
						<div class="form-text">Required when creating a group chat with multiple recipients.</div>
					</div>

					<!-- Media Upload Section -->
					<div v-if="selectedNewChatImage" class="mb-3">
						<label class="form-label">Selected Media</label>
						<div class="image-preview-container">
							<img
								:src="newChatImagePreviewUrl"
								:alt="selectedNewChatImage.name"
								class="preview-message-image"
								style="max-width: 200px; max-height: 150px;"
							>
							<button
								type="button"
								class="btn btn-sm btn-danger remove-image-btn"
								@click="clearNewChatImageSelection"
								title="Remove media"
							>
								<svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16">
									<path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
								</svg>
							</button>
						</div>
						<div class="image-info mt-2">
							<small class="text-muted">{{ selectedNewChatImage.name }} ({{ formatFileSize(selectedNewChatImage.size) }})</small>
						</div>
					</div>

					<!-- Initial Message Section -->
					<div class="mb-3">
						<label class="form-label">Initial Message</label>
						<div class="input-group">
							<!-- Add Media Button -->
							<button
								type="button"
								class="btn btn-outline-secondary"
								@click="openNewChatImageModal"
								title="Add image or GIF"
							>
								<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
									<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
								</svg>
							</button>
							<input
								type="text"
								class="form-control"
								:placeholder="selectedNewChatImage ? 'Add a caption...' : 'Type your first message...'"
								v-model="initialMessage"
							>
						</div>
						<div class="form-text">Optional: Send an initial message to start the conversation.</div>
					</div>

					<ErrorMsg v-if="newChatError" :message="newChatError"/>
				</div>
				<div class="vue-modal-footer">
					<button type="button" class="btn btn-secondary" @click="closeNewChatModal">Cancel</button>
					<button
						type="button"
						class="btn btn-primary"
						@click="createNewChat"
						:disabled="newChatLoading || selectedUsers.length === 0 || (selectedUsers.length > 1 && !newChatName.trim())"
					>
						<div v-if="newChatLoading" class="spinner-border spinner-border-sm me-2" role="status">
							<span class="visually-hidden">Creating...</span>
						</div>
						Create {{ selectedUsers.length > 1 ? 'Group' : 'Chat' }}
					</button>
				</div>
			</div>
		</div>
	</div>

	<div v-if="showNewChatImageModal" class="vue-modal" @click.self="closeNewChatImageModal">
		<div class="vue-modal-dialog">
			<div class="vue-modal-content">
				<div class="vue-modal-header">
					<h5 class="vue-modal-title">Add Image or GIF</h5>
					<button type="button" class="vue-modal-close" @click="closeNewChatImageModal">Ã—</button>
				</div>
				<div class="vue-modal-body">
					<!-- File Upload Section -->
					<div class="mb-3">
						<label class="form-label">Choose Image or GIF</label>
						<input
							type="file"
							class="form-control"
							ref="newChatImageInput"
							@change="handleNewChatImageSelect"
							accept="image/*,.gif"
						>
						<div class="form-text">Supported formats: JPG, PNG, GIF, WebP. Max size: 10MB</div>
					</div>

					<!-- Image Preview -->
					<div v-if="tempNewChatImage" class="mb-3 text-center">
						<label class="form-label">Preview</label>
						<div class="photo-preview">
							<img
								:src="tempNewChatImagePreviewUrl"
								alt="Preview"
								class="preview-message-image"
								style="max-width: 300px; max-height: 300px;"
							>
						</div>
						<div class="mt-2">
							<small class="text-muted">{{ tempNewChatImage.name }} ({{ formatFileSize(tempNewChatImage.size) }})</small>
						</div>
					</div>

					<!-- Error Message -->
					<div v-if="newChatImageModalError" class="error-msg">{{ newChatImageModalError }}</div>
				</div>
				<div class="vue-modal-footer">
					<button type="button" class="btn btn-secondary" @click="closeNewChatImageModal">Cancel</button>
					<button
						type="button"
						class="btn btn-primary"
						@click="selectNewChatImage"
						:disabled="!tempNewChatImage"
					>
						Add to Message
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Fixed Profile Modal -->
	<div v-if="showProfileModal" class="vue-modal" @click.self="showProfileModal = false">
		<div class="vue-modal-dialog">
			<div class="vue-modal-content">
				<div class="vue-modal-header">
					<h5 class="vue-modal-title">Edit Profile</h5>
					<button type="button" class="vue-modal-close" @click="showProfileModal = false">Ã—</button>
				</div>
				<div class="vue-modal-body">
					<!-- Current Profile Image -->
					<div v-if="currentUserImageUrl" class="mb-3 text-center">
						<label class="form-label">Current Profile Picture</label>
						<div class="current-photo-preview">
							<img
								:src="currentUserImageUrl"
								:alt="currentUsername || 'User'"
								class="current-group-photo"
								style="max-width: 150px; max-height: 150px;"
							>
						</div>
					</div>

					<!-- Username Field -->
					<div class="mb-3">
						<label class="form-label">Username</label>
						<input
							type="text"
							class="form-control"
							v-model="editUsername"
							placeholder="Enter new username"
							@keyup.enter="updateProfile"
						>
					</div>

					<!-- Profile Image Upload -->
					<div class="mb-3">
						<label class="form-label">Profile Picture</label>
						<input
							type="file"
							class="form-control"
							ref="profileImageInput"
							@change="handleProfileImageSelect"
							accept="image/*"
						>
						<div class="form-text">Supported formats: JPG, PNG, GIF. Max size: 5MB</div>
					</div>

					<!-- Profile Image Preview -->
					<div v-if="selectedProfileImage" class="mb-3 text-center">
						<label class="form-label">Preview</label>
						<div class="photo-preview">
							<img
								:src="profileImagePreviewUrl"
								alt="Preview"
								class="preview-group-photo"
								style="max-width: 150px; max-height: 150px;"
							>
						</div>
						<button
							type="button"
							class="btn btn-sm btn-outline-secondary mt-2"
							@click="clearProfileImageSelection"
						>
							Remove Photo
						</button>
					</div>

					<ErrorMsg v-if="profileError" :message="profileError"/>
				</div>
				<div class="vue-modal-footer">
					<button type="button" class="btn btn-secondary" @click="showProfileModal = false">Cancel</button>
					<button
						type="button"
						class="btn btn-primary"
						@click="updateProfile"
						:disabled="profileLoading"
					>
						<div v-if="profileLoading" class="spinner-border spinner-border-sm me-2" role="status">
							<span class="visually-hidden">Updating...</span>
						</div>
						Update Profile
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Rename Group Modal -->
	<div v-if="showSetGroupNameModal" class="vue-modal" @click.self="showSetGroupNameModal = false">
		<div class="vue-modal-dialog">
			<div class="vue-modal-header">
				<h5 class="vue-modal-title">Rename Group</h5>
				<button class="vue-modal-close" @click="showSetGroupNameModal = false">Ã—</button>
			</div>
			<div class="vue-modal-body">
				<div class="mb-3">
					<label class="form-label">Group Name</label>
					<input
						type="text"
						class="form-control"
						v-model="editGroupName"
						placeholder="Enter new group name"
						@keyup.enter="setGroupName"
						ref="groupNameInput"
					>
				</div>
				<div v-if="setGroupNameError" class="error-msg">{{ setGroupNameError }}</div>
			</div>
			<div class="vue-modal-footer">
				<button class="btn btn-secondary" @click="showSetGroupNameModal = false">Cancel</button>
				<button
					class="btn btn-primary"
					@click="setGroupName"
					:disabled="setGroupNameLoading || !editGroupName.trim()"
				>
					<div v-if="setGroupNameLoading" class="spinner-border"></div>
					Rename
				</button>
			</div>
		</div>
	</div>

	<!-- Add Member Modal -->
	<div v-if="showAddToGroupModal" class="vue-modal" @click.self="showAddToGroupModal = false">
		<div class="vue-modal-dialog">
			<div class="vue-modal-header">
				<h5 class="vue-modal-title">Add Member to Group</h5>
				<button class="vue-modal-close" @click="showAddToGroupModal = false">Ã—</button>
			</div>
			<div class="vue-modal-body">
				<div class="mb-3">
					<label class="form-label">Username</label>
					<input
						type="text"
						class="form-control"
						v-model="newMemberUsername"
						placeholder="Enter username to add"
						@keyup.enter="addToGroup"
						ref="memberUsernameInput"
					>
					<div class="form-text">Enter the username of the person you want to add to this group.</div>
				</div>
				<div v-if="addToGroupError" class="error-msg">{{ addToGroupError }}</div>
			</div>
			<div class="vue-modal-footer">
				<button class="btn btn-secondary" @click="showAddToGroupModal = false">Cancel</button>
				<button
					class="btn btn-primary"
					@click="addToGroup"
					:disabled="addToGroupLoading || !newMemberUsername.trim()"
				>
					<div v-if="addToGroupLoading" class="spinner-border"></div>
					Add Member
				</button>
			</div>
		</div>
	</div>

	<!-- Image Selection Modal -->
	<div v-if="showImageModal" class="vue-modal" @click.self="closeImageModal">
		<div class="vue-modal-dialog">
			<div class="vue-modal-content">
				<div class="vue-modal-header">
					<h5 class="vue-modal-title">Add Image or GIF</h5>
					<button type="button" class="vue-modal-close" @click="closeImageModal">Ã—</button>
				</div>
				<div class="vue-modal-body">
					<!-- File Upload Section -->
					<div class="mb-3">
						<label class="form-label">Choose Image or GIF</label>
						<input
							type="file"
							class="form-control"
							ref="messageImageInput"
							@change="handleMessageImageSelect"
							accept="image/*,.gif"
						>
						<div class="form-text">Supported formats: JPG, PNG, GIF, WebP. Max size: 10MB</div>
					</div>

					<!-- Image Preview -->
					<div v-if="tempSelectedImage" class="mb-3 text-center">
						<label class="form-label">Preview</label>
						<div class="photo-preview">
							<img
								:src="tempImagePreviewUrl"
								alt="Preview"
								class="preview-message-image"
								style="max-width: 300px; max-height: 300px;"
							>
						</div>
						<div class="mt-2">
							<small class="text-muted">{{ tempSelectedImage.name }} ({{ formatFileSize(tempSelectedImage.size) }})</small>
						</div>
					</div>

					<!-- Error Message -->
					<div v-if="imageModalError" class="error-msg">{{ imageModalError }}</div>
				</div>
				<div class="vue-modal-footer">
					<button type="button" class="btn btn-secondary" @click="closeImageModal">Cancel</button>
					<button
						type="button"
						class="btn btn-primary"
						@click="selectMessageImage"
						:disabled="!tempSelectedImage"
					>
						Add to Message
					</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Set Group Photo Modal -->
	<div v-if="showSetGroupPhotoModal" class="vue-modal" @click.self="showSetGroupPhotoModal = false">
		<div class="vue-modal-dialog">
			<div class="vue-modal-content">
				<div class="vue-modal-header">
					<h5 class="vue-modal-title">Set Group Photo</h5>
					<button class="vue-modal-close" @click="showSetGroupPhotoModal = false">Ã—</button>
				</div>
				<div class="vue-modal-body">
					<!-- Current Photo Preview -->
					<div v-if="selectedChat && chatImageUrls[selectedChat.id]" class="mb-3 text-center">
						<label class="form-label">Current Photo</label>
						<div class="current-photo-preview">
							<img
								:src="chatImageUrls[selectedChat.id]"
								:alt="getChatName(selectedChat)"
								class="current-group-photo"
							>
						</div>
					</div>

					<!-- File Upload Section -->
					<div class="mb-3">
						<label class="form-label">Choose New Photo</label>
						<input
							type="file"
							class="form-control"
							ref="photoFileInput"
							@change="handlePhotoFileSelect"
							accept="image/*"
						>
						<div class="form-text">Supported formats: JPG, PNG, GIF. Max size: 5MB</div>
					</div>

					<!-- Photo Preview -->
					<div v-if="selectedPhotoFile" class="mb-3 text-center">
						<label class="form-label">Preview</label>
						<div class="photo-preview">
							<img
								:src="photoPreviewUrl"
								alt="Preview"
								class="preview-group-photo"
							>
						</div>
						<button
							type="button"
							class="btn btn-sm btn-outline-secondary mt-2"
							@click="clearPhotoSelection"
						>
							Remove Photo
						</button>
					</div>

					<!-- Error Message -->
					<div v-if="setGroupPhotoError" class="error-msg">{{ setGroupPhotoError }}</div>
				</div>
				<div class="vue-modal-footer">
					<button class="btn btn-secondary" @click="showSetGroupPhotoModal = false">Cancel</button>
					<button
						class="btn btn-primary"
						@click="setGroupPhoto"
						:disabled="setGroupPhotoLoading || !selectedPhotoFile"
					>
						<div v-if="setGroupPhotoLoading" class="spinner-border spinner-border-sm me-2" role="status">
							<span class="visually-hidden">Uploading...</span>
						</div>
						{{ selectedPhotoFile ? 'Update Photo' : 'Select Photo' }}
					</button>
				</div>
			</div>
		</div>
	</div>
</div>





